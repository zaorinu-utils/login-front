<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Zunalita Auth</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 3rem; }
    button { padding: 10px 20px; font-size: 1rem; margin: 1rem; }
  </style>
</head>
<body>
  <h1>Click to Login!</h1>
  <div id="user">Verifying...</div>
  <button id="loginBtn" style="display:none;">Enter with Github</button>
  <button id="logoutBtn" style="display:none;">Logout</button>

  <script>
    const clientId = 'Ov23liDydrs0YSmOnO9m';
    const redirectUri = 'https://login-tests-six.vercel.app/api/callback';
    const backendURL = 'https://login-tests-six.vercel.app';

    const userDiv = document.getElementById('user');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    loginBtn.onclick = () => {
      window.location.href = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}`;
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem('token');
      showLoggedOut();
    };

    function showLogged(username) {
      userDiv.textContent = `Hello, ${username}!`;
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
    }

    function showLoggedOut() {
      userDiv.textContent = 'You are not logged.';
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
    }

    async function getClientIp() {
      try {
        const res = await fetch('https://api.ipify.org?format=text');
        return await res.text();
      } catch {
        return null;
      }
    }

    async function validate(token) {
      const clientIp = await getClientIp();
      if (!clientIp) {
        // Se não conseguir pegar IP, consideramos inválido por segurança
        return { valid: false, error: 'Unable to get client IP' };
      }

      const res = await fetch(`${backendURL}/api/validate`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          'X-Client-IP': clientIp
        },
      });
      const data = await res.json();

      // Se token inválido por causa do IP, remove localStorage
      if (!data.valid) {
        localStorage.removeItem('token');
      }

      return data;
    }

    async function init() {
      const urlToken = new URLSearchParams(window.location.search).get('token');
      if (urlToken) {
        localStorage.setItem('token', urlToken);
        window.history.replaceState({}, document.title, '/login-front/');
      }

      const token = localStorage.getItem('token');
      if (token) {
        const data = await validate(token);
        if (data.valid) {
          showLogged(data.username);
        } else {
          showLoggedOut();
        }
      } else {
        showLoggedOut();
      }
    }

    init();
  </script>
</body>
</html>
