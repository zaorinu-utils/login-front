<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Zunalita Auth</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 3rem; }
    button { padding: 10px 20px; font-size: 1rem; margin: 1rem; }
  </style>
</head>
<body>
  <h1>Click to Login!</h1>
  <div id="user">Verifying...</div>
  <button id="loginBtn" style="display:none;">Enter with Github</button>
  <button id="logoutBtn" style="display:none;">Logout</button>

  <script>
    const clientId = 'Ov23liDydrs0YSmOnO9m';
    const redirectUri = 'https://login-tests-six.vercel.app/api/callback';
    const backendURL = 'https://login-tests-six.vercel.app';

    const userDiv = document.getElementById('user');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // Controle de rate limit no cliente
    function podeValidar() {
      const LIMITE = 5;
      const INTERVALO = 60 * 1000; // 1 minuto
      const agora = Date.now();
      let historico = JSON.parse(localStorage.getItem('validate_attempts')) || [];
      historico = historico.filter(ts => agora - ts < INTERVALO);

      if (historico.length >= LIMITE) {
        localStorage.setItem('validate_bloqueado', 'true');
        return false;
      }
      historico.push(agora);
      localStorage.setItem('validate_attempts', JSON.stringify(historico));
      localStorage.removeItem('validate_bloqueado');
      return true;
    }

    loginBtn.onclick = () => {
      window.location.href = `https://github.com/login/oauth/authorize?client_id=${clientId}&redirect_uri=${encodeURIComponent(redirectUri)}`;
    };

    logoutBtn.onclick = () => {
      localStorage.removeItem('token');
      showLoggedOut();
    };

    function showLogged(username) {
      userDiv.textContent = `Hello, ${username}!`;
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-block';
    }

    function showLoggedOut() {
      userDiv.textContent = 'You are not logged.';
      loginBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'none';
    }

    async function validate(token) {
      // Conta tentativas para rate limit
      let tentativas = 0;
      let historico = JSON.parse(localStorage.getItem('validate_attempts')) || [];
      const agora = Date.now();
      historico = historico.filter(ts => agora - ts < 60 * 1000);
      tentativas = historico.length;

      const res = await fetch(`${backendURL}/api/validate?token=${token}`, {
        headers: {
          'x-login-attempts': tentativas
        }
      });
      // Atualiza tentativas após a requisição
      if (res.status === 429) {
        localStorage.setItem('validate_bloqueado', 'true');
      }
      const data = await res.json();
      return data;
    }

    async function init() {
      const urlToken = new URLSearchParams(window.location.search).get('token');
      if (urlToken) {
        localStorage.setItem('token', urlToken);
        window.history.replaceState({}, document.title, '/login-front/');
      }

      // Checa se está bloqueado
      if (localStorage.getItem('validate_bloqueado')) {
        userDiv.textContent = 'Você atingiu o limite de tentativas. Tente novamente em 1 minuto.';
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        return;
      }

      const token = localStorage.getItem('token');
      if (token) {
        if (!podeValidar()) {
          userDiv.textContent = 'Você atingiu o limite de tentativas. Tente novamente em 1 minuto.';
          loginBtn.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
          return;
        }
        const data = await validate(token);
        if (data.valid) {
          showLogged(data.username);
        } else {
          showLoggedOut();
        }
      } else {
        showLoggedOut();
      }
    }

    init();
  </script>
</body>
</html>
